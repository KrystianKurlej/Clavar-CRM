<!doctype html>
<html lang="pl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Projekty — Simple CRM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  </head>
  <body class="bg-light">
    <div data-include="/partials/nav.html"></div>

    <div class="container py-4">
      <h1 class="mb-3">Projekty</h1>
      <form id="createForm" class="row g-2 mb-3">
        <div class="col-auto">
          <input id="name" class="form-control" placeholder="Nazwa projektu" />
        </div>
        <div class="col-auto">
          <button class="btn btn-primary" type="submit">Dodaj</button>
        </div>
        <div class="col-12"><small id="err" class="text-danger"></small></div>
      </form>

      <ul id="projects" class="list-group">
        <!-- dynamic -->
      </ul>
    </div>

    <div data-include="/partials/footer.html"></div>

    <script src="/assets/tinyview.js"></script>
    <script>
      async function api(path, opts = {}) {
        const res = await fetch(path, Object.assign({ credentials: 'include' }, opts));
        if (res.status === 204) return null;
        try { return await res.json(); } catch(e){ return null; }
      }
      async function csrf(){ const d = await api('/api/csrf'); return d?.csrf; }

      function renderList(items){
        const ul = document.getElementById('projects');
        ul.innerHTML = '';
        if (!items || items.length === 0) {
          ul.innerHTML = '<li class="list-group-item text-muted">Brak projektów</li>';
          return;
        }
        for(const p of items){
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          li.innerHTML = `
            <span>${p.name}</span>
            <span>
              <button data-act="archive" data-id="${p.id}" class="btn btn-sm btn-outline-secondary me-2">Archiwizuj</button>
              <button data-act="delete" data-id="${p.id}" class="btn btn-sm btn-outline-danger">Usuń</button>
            </span>`;
          ul.appendChild(li);
        }
      }

      async function load(){
        const me = await api('/api/me');
        if (!me || !me.ok) { location.href = '/login.html'; return; }
        const res = await api('/api/projects');
        renderList(res?.projects || []);
      }

      document.getElementById('createForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        document.getElementById('err').textContent = '';
        const name = document.getElementById('name').value.trim();
        if (!name) { document.getElementById('err').textContent = 'Podaj nazwę'; return; }
        const token = await csrf();
        const res = await api('/api/projects', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, _csrf: token }) });
        if (!res || !res.ok) { document.getElementById('err').textContent = res?.error || 'Błąd'; return; }
        document.getElementById('name').value = '';
        await load();
      });

      document.getElementById('projects').addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const act = btn.getAttribute('data-act');
        const token = await csrf();
        if (act === 'archive') {
          await api(`/api/projects/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ archived: 1, _csrf: token }) });
        } else if (act === 'delete') {
          await api(`/api/projects/${id}`, { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ _csrf: token }) });
        }
        await load();
      });

      load();
    </script>
  </body>
</html>
